# Machinator: The Ultimate Vision

_Architecture Roadmap & System State_

**Document Owner:** Orchestrator Team  
**Last Updated:** January 2026

---

## 1. Executive Summary

The goal is to evolve `machinator` from a disjointed set of tools (setup wizard + single-agent orchestrator) into a unified, intelligent multi-agent platform. A single `machinator` binary will seamlessly handle environment bootstrapping, project configuration, and multi-agent orchestration, behaving as a "self-driving" coding manager.

## 2. Core Principles

1.  **Unified Entry Point**: One binary (`machinator`). No separate `setup` command.
2.  **Context Aware**: Automatically detects if it needs to run First-Time Setup or launch the Orchestrator based on the current directory state.
3.  **Configuration-Driven**: The Orchestrator is fully dynamic, reading project/agent definitions from the config generated by Setup.
4.  **Testability First**: The system must be testable via "Dummy Components" (Fake Gemini, Fake Repo) to allow robust simulation of complex multi-agent scenarios without spending real money/tokens.

---

## 3. Architecture Transition

### Current State (AS-IS)

- **Dual Binaries**: `setup` (wizard) and `orchestrator` (execution) are separate.
- **Hardcoded Defaults**: Orchestrator often assumes 1 agent, system defaults, and manual quota management.
- **Fragmented Config**: Setup writes `project.json`, but Orchestrator doesn't fully utilize it dynamically.

### Future State (TO-BE)

- **Unified Binary**: `machinator`
  - **Startup Logic**:
    - Checks `~/.machinator/global_config.json` (or similar).
    - Checks current directory for `machinator.json` (Project context).
    - **IF** Config Missing OR No Projects defined -> **Launch Setup Mode** (TUI).
    - **ELSE** -> **Launch Orchestrator Mode** (TUI) in PAUSED state.
- **Dynamic Orchestration**:
  - Reads `project.json` to spawn N agents.
  - Manages shared resources (Gemini Quota) across these N agents.
- **Unified UI**: A single Bubble Tea application that can switch between "Setup Views" and "Orchestrator Views".

---

## 4. Multi-Agent Orchestrator UI

The TUI must evolve to visualize parallel work streams:

- **Agent Grid**: A dashboard showing status of multiple agents (Active/Idle/Error).
- **Focus View**: Drill down into a specific agent to see its terminal output/bead status.
- **Global HUD**: Top bar showing Aggregate Quota usage, Total Beads remaining, System Health.
- **Control Plane**: Global Pause/Resume, Panic Button (Stop All), Agent Re-assignment.

---

## 5. Testing Infrastructure (The "Simulacrum")

To robustly test this complex system, we cannot rely on live LLMs. We need a simulation environment.

### A. The "Dummy" Gemini CLI

A mock replacement for the real Gemini CLI.

- **Behavior**: Accepts standard flags (`--prompt`, `--repo`, etc.).
- **Modes** (controlled via ENV vars):
  - `MODE=HAPPY`: Returns success immediately.
  - `MODE=ERROR`: Returns random 500s or quota errors.
  - `MODE=STUCK`: Hangs indefinitely (to test timeout logic).
  - `MODE=SCRIPTED`: Replays a sequence of responses from a file.

### B. The "Test fixture" Repo

A dedicated git repository (or a generated temp repo) containing:

- Standard `.beads` structure.
- Pre-defined issues (Beads) with known dependencies.
- Goal: Run `machinator` against this repo with `Dummy Gemini` and verify that beads move from `open` -> `in_progress` -> `closed` correctly.

---

## 6. Execution Roadmap (Beads)

This roadmap guides the "Scrum Master" agent in prioritizing future beads.

### Phase 1: Unification & Config Injection

- [ ] Refactor `setup` logic into a reusable package (not just `main`).
- [ ] Create root `machinator` command that imports `setup` and `orchestrator`.
- [ ] Update Orchestrator to accept `ProjectConfig` injection.

### Phase 2: The Simulacrum (Testing)

- [ ] Create `tools/dummy-gemini` binary.
- [ ] Create E2E test harness using `testdata/fixture-repo`.

### Phase 3: Multi-Agent UI

- [ ] Design "Agent Grid" component in Bubble Tea.
- [ ] Implement "Agent Manager" logic (managing N `tea.Model` instances).

### Phase 4: Full Integration

- [ ] Replace `orchestrator` entry point with `machinator`.
- [ ] Deprecate standalone `setup` binary.

---

## 7. Directives for Future Agents

- **Review this Plan**: Before picking up a bead, verify it aligns with the "Unified Binary" vision.
- **Don't Fork**: Do not create separate tools. Refactor existing ones into the unified structure.
- **Simulate**: When building the multi-agent scheduler, use the Dummy CLI approach first. Don't burn tokens debugging scheduler logic.
