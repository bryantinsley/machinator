# Comprehensive TUI Testing & Visual Verification Strategy

This strategy ensures the `setup` TUI remains stable, visually consistent, and documented through automated tests and visual artifacts. It allows developers to "step away" while having confidence that the system's state is preserved and verified.

## 1. Testing Layers

### A. Unit & Logic Tests (`go test`)

- **Scope**: Internal logic (state transitions, key handling, basic view rendering strings).
- **Tool**: Go standard `testing` package.
- **Goal**: Verify that pressing "Delete" actually changes the state to "ConfirmDelete", or that "Tab" cycles the focus index.
- **Current Status**: Implemented in `main_test.go`.

### B. Golden File / Snapshot Tests (`teatest`)

- **Scope**: Precise output verification. Compares the full string output of the TUI against a stored "golden" reference file.
- **Tool**: `github.com/charmbracelet/x/exp/teatest`.
- **Goal**: Detect accidental layout shifts, text changes, or border breakages. If a pixel (char) changes, the test fails unless explicitly updated.
- **Workflow**:
  - Run `go test ./...` → Fails if output differs.
  - Run `go test ./... -update` → Updates golden files if the change is intentional.

### C. Visual Integration Flows (`vhs`)

- **Scope**: End-to-End user workflows recorded as GIFs and ASCII output.
- **Tool**: Charmbracelet `vhs`.
- **Goal**: Provide a "Visual History" of the application. Allows a human to quickly scan GIFs to see how the UI looked and behaved at that commit.
- **Artifacts**: stored in `docs/ui-history/`.

## 2. Artifact Management policy

- **Golden Files**: Stored in `orchestrator/cmd/setup/testdata/`. Checked into git.
- **VHS Tapes**: `.tape` scripts stored in `orchestrator/e2e/`.
- **Visual Proofs**: `*.gif` files generated by VHS stored in `docs/ui-history/`. Checked into git.
- **Commit Rule**: "Visual artifacts must be updated right before submission."

## 3. Automation & Governance

### `AGENTS.md` Rules

Future agents must follow these rules:

1.  **Visual Proof Required**: Any task involving UI changes MUST include updating the relevant VHS tapes and Golden files.
2.  **Trust the Tape**: Before marking a task done, review the generated GIF to ensure no visual regressions (alignment, colors).
3.  **Fix-Before-Commit**: If `go test` fails due to golden mismatch, verify the change, then update with `-update`.

### Pre-commit Checks

The `pre-commit` hook will be updated to:

1.  Run `go test ./...` (Unit + Golden).
2.  (Optional) Verify that `.tape` files have corresponding up-to-date `.gif` files (timestamp check).

---

# Execution Plan (Beads)

The following beads will be created to implement this strategy:

## Bead 1: TUI Golden File Infrastructure

**Objective**: Enhance `main_test.go` to support proper Golden File testing.

- [ ] Refactor `main_test.go` to use `teatest.RequireEqualOutput` with golden file storage.
- [ ] Generate initial golden files for: Main Screen, Project Detail, Edit Modal, Agent Count, Delete Confirmation.
- [ ] Verify `go test -update` workflow works.

## Bead 2: VHS End-to-End Suite

**Objective**: Create `vhs` tape scripts for core workflows.

- [ ] Install `vhs` (or assume available).
- [ ] Create `orchestrator/e2e/add_project.tape`.
- [ ] Create `orchestrator/e2e/edit_project.tape`.
- [ ] Create `orchestrator/e2e/delete_project.tape`.
- [ ] Configure output to `docs/ui-history/`.

## Bead 3: Governance & Documentation

**Objective**: Codify the rules so agents follow them.

- [ ] Update `AGENTS.md` with "Visual Evidence" rules.
- [ ] Create `scripts/update-ui-artifacts.sh` helper helper script (runs tests --update and regenerates tapes).
- [ ] Update `scripts/hooks/pre-commit` to ensure tests passing.
