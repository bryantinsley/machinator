#!/bin/bash
# Pre-commit hook - CHECKS formatting and tidiness, blocks commit if issues found
# Enable: git config core.hooksPath scripts/hooks
# Fix issues: scripts/fix-all.sh

set -e

FAILED=0

# ═══════════════════════════════════════════════════════════════════════════════
# 1. Run beads pre-commit hook (flushes changes to JSONL)
# ═══════════════════════════════════════════════════════════════════════════════
if command -v bd &> /dev/null; then
    bd hooks run pre-commit "$@" || true
fi

# ═══════════════════════════════════════════════════════════════════════════════
# 2. Check Go files formatting with gofmt
# ═══════════════════════════════════════════════════════════════════════════════
GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$GO_FILES" ]; then
    if command -v gofmt &> /dev/null; then
        UNFORMATTED=$(gofmt -l $GO_FILES 2>/dev/null || true)
        if [ -n "$UNFORMATTED" ]; then
            echo "❌ Go files need formatting:"
            echo "$UNFORMATTED"
            echo "   Run: gofmt -w <file>"
            FAILED=1
        fi
    fi
fi

# ═══════════════════════════════════════════════════════════════════════════════
# 3. Check Bazel files with buildifier
# ═══════════════════════════════════════════════════════════════════════════════
BAZEL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(BUILD|WORKSPACE|\.bzl)$' || true)

if [ -n "$BAZEL_FILES" ]; then
    if command -v buildifier &> /dev/null; then
        for file in $BAZEL_FILES; do
            if [ -f "$file" ]; then
                if ! buildifier -mode=check "$file" 2>/dev/null; then
                    echo "❌ Bazel file needs formatting: $file"
                    echo "   Run: buildifier -mode=fix $file"
                    FAILED=1
                fi
            fi
        done
    else
        echo "⚠️  buildifier not found. Install: brew install buildifier"
    fi
fi

# ═══════════════════════════════════════════════════════════════════════════════
# 4. Check go.mod/go.sum are tidy
# ═══════════════════════════════════════════════════════════════════════════════
if [ -f "go.mod" ] && command -v go &> /dev/null; then
    # Create temp copies, run tidy, check for diffs
    cp go.mod go.mod.backup 2>/dev/null || true
    cp go.sum go.sum.backup 2>/dev/null || true
    
    go mod tidy 2>/dev/null || true
    
    if ! diff -q go.mod go.mod.backup &>/dev/null || ! diff -q go.sum go.sum.backup &>/dev/null; then
        echo "❌ go.mod/go.sum need tidying"
        echo "   Run: go mod tidy"
        FAILED=1
    fi
    
    # Restore originals
    mv go.mod.backup go.mod 2>/dev/null || true
    mv go.sum.backup go.sum 2>/dev/null || true
fi

# ═══════════════════════════════════════════════════════════════════════════════
# Result
# ═══════════════════════════════════════════════════════════════════════════════
if [ $FAILED -eq 1 ]; then
    echo ""
    echo "❌ Pre-commit checks FAILED. Fix issues and try again."
    echo "   Or run: scripts/fix-all.sh"
    exit 1
fi

echo "✅ Pre-commit checks passed"
