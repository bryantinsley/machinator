#!/bin/bash
# Pre-commit hook - CHECKS formatting and tidiness, blocks commit if issues found
# Enable: git config core.hooksPath scripts/hooks
# Fix issues: scripts/fix-all.sh

set -e

FAILED=0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. Run beads pre-commit hook (flushes changes to JSONL)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if command -v bd &> /dev/null; then
    bd hooks run pre-commit "$@" || true
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. Check Go files formatting with gofmt
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$GO_FILES" ]; then
    if command -v gofmt &> /dev/null; then
        UNFORMATTED=$(gofmt -l $GO_FILES 2>/dev/null || true)
        if [ -n "$UNFORMATTED" ]; then
            echo "âŒ Go files need formatting:"
            echo "$UNFORMATTED"
            echo "   Run: gofmt -w <file>"
            FAILED=1
        fi
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. Check Bazel files with buildifier
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BAZEL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(BUILD|WORKSPACE|\.bzl)$' || true)

if [ -n "$BAZEL_FILES" ]; then
    if command -v buildifier &> /dev/null; then
        for file in $BAZEL_FILES; do
            if [ -f "$file" ]; then
                if ! buildifier -mode=check "$file" 2>/dev/null; then
                    echo "âŒ Bazel file needs formatting: $file"
                    echo "   Run: buildifier -mode=fix $file"
                    FAILED=1
                fi
            fi
        done
    else
        echo "âš ï¸  buildifier not found. Install: brew install buildifier"
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. Check go.mod/go.sum are tidy
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ -f "go.mod" ] && command -v go &> /dev/null; then
    # Create temp copies, run tidy, check for diffs
    cp go.mod go.mod.backup 2>/dev/null || true
    cp go.sum go.sum.backup 2>/dev/null || true
    
    go mod tidy 2>/dev/null || true
    
    if ! diff -q go.mod go.mod.backup &>/dev/null || ! diff -q go.sum go.sum.backup &>/dev/null; then
        echo "âŒ go.mod/go.sum need tidying"
        echo "   Run: go mod tidy"
        FAILED=1
    fi
    
    # Restore originals
    mv go.mod.backup go.mod 2>/dev/null || true
    mv go.sum.backup go.sum 2>/dev/null || true
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. Run UI tests and check for golden updates
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SETUP_DIR="orchestrator/pkg/setup"
UI_CHANGES=$(git diff --cached --name-only --diff-filter=ACM "$SETUP_DIR" | grep '\.go$' || true)
GOLDEN_CHANGES=$(git diff --cached --name-only --diff-filter=ACM "$SETUP_DIR/testdata" | grep '\.golden$' || true)

if [ -n "$UI_CHANGES" ]; then
    echo "ğŸ” UI changes detected in $SETUP_DIR. Running tests..."
    
    # Setup Go environment for the hook
    if [ -f "templates/setup_go_env.sh" ]; then
        source templates/setup_go_env.sh > /dev/null
    else
        export GOPATH="$(pwd)/.go-cache"
        export GOCACHE="$(pwd)/.go-build-cache"
        export GOMODCACHE="$(pwd)/.go-cache/pkg/mod"
        mkdir -p "$GOPATH" "$GOCACHE" "$GOMODCACHE"
    fi

    if ! go test "./$SETUP_DIR/..." > /dev/null 2>&1; then
        echo "âŒ UI tests failed in $SETUP_DIR. Golden files may need update."
        echo "   Run: go test ./$SETUP_DIR/... -update"
        FAILED=1
    elif [ -z "$GOLDEN_CHANGES" ]; then
        echo "âŒ UI changes detected in $SETUP_DIR but no golden files staged."
        echo "   Visual artifacts must be updated to prove the UI still looks correct."
        echo "   Run: go test ./$SETUP_DIR/... -update"
        echo "   Then: git add $SETUP_DIR/testdata/*.golden"
        FAILED=1
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. Check for stale VHS GIFs
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TAPE_DIR="orchestrator/e2e"
GIF_DIR="docs/ui-history"

for tape in "$TAPE_DIR"/*.tape; do
    if [ -f "$tape" ]; then
        base=$(basename "$tape" .tape)
        gif="$GIF_DIR/$base.gif"
        
        if [ -f "$gif" ]; then
            if [ "$tape" -nt "$gif" ]; then
                echo "âš ï¸  Warning: $base.gif may be stale. Run scripts/update-ui.sh"
            fi
        fi
    fi
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Result
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ $FAILED -eq 1 ]; then
    echo ""
    echo "âŒ Pre-commit checks FAILED. Fix issues and try again."
    echo "   Or run: scripts/fix-all.sh"
    exit 1
fi

echo "âœ… Pre-commit checks passed"
